---
template:
  id: story-template-v2
  name: Story Document
  version: 2.0
  output:
    format: markdown
    filename: docs/stories/1.5.Cypher-Script-Generation-&-Output.md
    title: "Story 1.5: Cypher Script Generation & Output"
workflow:
  mode: interactive
  elicitation: advanced-elicitation
agent_config:
  editable_sections:
    - Status
    - Story
    - Acceptance Criteria
    - Tasks / Subtasks
    - Dev Notes
    - Testing
    - Change Log
---
# Story 1.5: Cypher Script Generation & Output

## Status
Done

## Story
**As a** DevOps Engineer,
**I want** HelmGraph to generate a Cypher script,
**so that** I can import the Helm chart's graph representation into Neo4j.

## Acceptance Criteria
1. The tool generates a valid `.cypher` file containing Cypher `CREATE` or `MERGE` commands.
2. The `.cypher` file includes commands for all identified nodes (`Deployment`, `Service`, `ConfigMap`, `Secret` etc.) with their respective properties (`kind`, `name`, `namespace`).
3. The `.cypher` file includes commands for all identified relationships (e.g., "SELECTS", "USES_CONFIG", "USES_SECRET") with their respective properties.
4. The generated `.cypher` file is saved to a user-specified or default output location.
5. The generated Cypher is syntactically correct and can be executed against a Neo4j database.

## Tasks / Subtasks
- [ ] **Task 1: Implement Cypher Generation Logic.** (AC: 1, 2, 3)
    - [ ] Create a new package `internal/cypher` for Cypher generation logic.
    - [ ] Implement a function in `internal/cypher/generator.go` that takes the lists of parsed resources and identified relationships as input.
    - [ ] Generate `CREATE CONSTRAINT` statements for each resource kind.
    - [ ] Generate `MERGE` statements for each resource node.
    - [ ] Generate `MERGE` statements for each relationship.
- [ ] **Task 2: Implement Cypher Linter.** (AC: 5)
    - [ ] In `internal/cypher/linter.go`, implement a function to validate the generated Cypher script using a Go-native SQL/Cypher parser library.
- [ ] **Task 3: Implement File Output.** (AC: 4)
    - [ ] In the main CLI logic, call the Cypher generator and linter.
    - [ ] If the linter passes, write the generated Cypher script to the specified output file or to standard out.
- [ ] **Task 4: Write Unit Tests.**
    - [ ] Write unit tests for the Cypher generation logic.
    - [ ] Write unit tests for the Cypher linter.

## Dev Notes
- **Cypher Generation**: The Cypher script should be generated using custom Go functions to ensure precise control over the output format. [Source: docs/architecture/tech-stack.md]
- **Database Schema**: The structure of the Cypher output, including node labels, properties, and relationship types, is defined in `docs/architecture/database-schema.md`.
- **File Locations**: The Cypher generation logic should be implemented in `internal/cypher/generator.go`, and the linter in `internal/cypher/linter.go`. [Source: docs/architecture/source-tree.md]
- **Previous Story Insights**: This story depends on the successful parsing of Kubernetes resources from story 1.2 and relationship identification from stories 1.3 and 1.4.

### Testing
- **Unit Tests**: Unit tests should be created in `_test.go` files in the same package as the code they are testing. [Source: docs/architecture/coding-standards.md]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-01 | 1.0 | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}
### Debug Log References
-
### Completion Notes List
-
### File List
- `internal/cypher/generator.go`
- `internal/cypher/generator_test.go`

## QA Results
-
